<script>

let current = null;

/* START DRAG */
document.querySelectorAll(".draggable").forEach(item=>{
item.addEventListener("touchstart", startDrag, {passive:false});
item.addEventListener("mousedown", startDrag);
});

function startDrag(e){

e.preventDefault();

current = this;

current.classList.add("dragging");

current.style.position = "fixed";
current.style.zIndex = "1000";

moveAt(e);

document.addEventListener("touchmove", moveAt, {passive:false});
document.addEventListener("mousemove", moveAt);

document.addEventListener("touchend", endDrag);
document.addEventListener("mouseup", endDrag);
}

/* MOVE */
function moveAt(e){

if(!current) return;

let x, y;

if(e.touches){
x = e.touches[0].clientX;
y = e.touches[0].clientY;
}else{
x = e.clientX;
y = e.clientY;
}

current.style.left = (x - current.offsetWidth/2) + "px";
current.style.top  = (y - current.offsetHeight/2) + "px";
}

/* END DRAG */
function endDrag(){

if(!current) return;

let dropped = false;

document.querySelectorAll(".dropzone").forEach(zone=>{
const rect = zone.getBoundingClientRect();
const itemRect = current.getBoundingClientRect();

if(
itemRect.left < rect.right &&
itemRect.right > rect.left &&
itemRect.top < rect.bottom &&
itemRect.bottom > rect.top
){
zone.appendChild(current);
current.style.position="relative";
current.style.left="0";
current.style.top="0";
checkMatch(zone, current);
dropped = true;
}
});

if(!dropped){
resetPosition(current);
}

current.classList.remove("dragging");
current = null;

document.removeEventListener("touchmove", moveAt);
document.removeEventListener("mousemove", moveAt);
document.removeEventListener("touchend", endDrag);
document.removeEventListener("mouseup", endDrag);
}

/* RESET */
function resetPosition(item){
item.style.position="relative";
item.style.left="0";
item.style.top="0";
document.querySelector(".draggables").appendChild(item);
}

/* VALIDAZIONE */
function checkMatch(zone, item){

if(zone.dataset.person === item.dataset.match){
zone.classList.add("correct");
item.style.pointerEvents="none";
}else{
zone.classList.add("wrong");
setTimeout(()=>{
zone.classList.remove("wrong");
resetPosition(item);
},700);
}

checkWin();
}

/* WIN */
function checkWin(){
let correct = document.querySelectorAll(".dropzone.correct").length;
if(correct === 4){
setTimeout(()=>{
window.location.href="stanza6.html";
},800);
}
}

</script>
