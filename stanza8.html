<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Stanza 8 - Mise en place</title>

<style>
html,body{
  margin:0;
  height:100%;
  font-family:Arial;
  background:#111;
  display:flex;
  flex-direction:column;
  align-items:center;
  color:#fff;
  overflow:hidden;
}

.header{
  padding:20px 0 10px;
  text-align:center;
}

/* TAVOLO */
.table{
  width:min(820px,96vw);
  aspect-ratio:4/3;
  position:relative;
  border-radius:24px;
  overflow:hidden;
  box-shadow:0 25px 60px rgba(0,0,0,.6);

  background:
    repeating-linear-gradient(0deg,#ffffff,#ffffff 40px,#f2f2f2 40px,#f2f2f2 80px),
    repeating-linear-gradient(90deg,#ffffff,#ffffff 40px,#f2f2f2 40px,#f2f2f2 80px);
}

/* TARGET AMPI */
.target{
  position:absolute;
  border-radius:50%;
  width:260px;
  height:260px;
  z-index:1;
}

/* CENTRO */
#t-center{
  top:50%;
  left:50%;
  transform:translate(-50%,-50%);
}

/* SINISTRA */
#t-fork-main{
  top:50%; left:30%;
  transform:translate(-50%,-50%);
  width:200px; height:260px;
}
#t-fork-second{
  top:50%; left:18%;
  transform:translate(-50%,-50%);
  width:200px; height:260px;
}

/* DESTRA */
#t-knife{
  top:50%; left:70%;
  transform:translate(-50%,-50%);
  width:200px; height:260px;
}
#t-spoon{
  top:50%; left:83%;
  transform:translate(-50%,-50%);
  width:200px; height:260px;
}

/* BICCHIERI */
#t-water{
  top:25%; left:75%;
  transform:translate(-50%,-50%);
  width:180px; height:180px;
}
#t-wine{
  top:22%; left:88%;
  transform:translate(-50%,-50%);
  width:180px; height:180px;
}

/* DESSERT */
#t-dessert{
  top:20%; left:50%;
  transform:translate(-50%,-50%);
  width:260px; height:120px;
}

/* OGGETTI */
.on-table{
  position:absolute;
  pointer-events:none;
  z-index:10;
}

.on-table img{
  width:100%;
  height:auto;
  display:block;
}

/* TOOLBOX */
.toolbox{
  margin-top:20px;
  display:flex;
  flex-wrap:wrap;
  justify-content:center;
  gap:12px;
  width:min(820px,96vw);
}

.draggable{
  width:64px;
  height:64px;
  background:#fff;
  border-radius:14px;
  display:flex;
  align-items:center;
  justify-content:center;
  cursor:grab;
}

.draggable img{
  max-width:80%;
  max-height:80%;
  pointer-events:none;
}

.drag-preview{
  position:fixed;
  z-index:9999;
  width:64px;
  height:64px;
  pointer-events:none;
}

.drag-preview img{ width:100%; }
</style>
</head>

<body>

<div class="header">
  <h1>Stanza 8</h1>
  <p>Completa la mise en place corretta.</p>
</div>

<div class="table" id="table">

  <div class="target" id="t-center"></div>

  <div class="target" id="t-fork-main"></div>
  <div class="target" id="t-fork-second"></div>

  <div class="target" id="t-knife"></div>
  <div class="target" id="t-spoon"></div>

  <div class="target" id="t-water"></div>
  <div class="target" id="t-wine"></div>

  <div class="target" id="t-dessert"></div>

</div>

<div class="toolbox">

  <div class="draggable" data-item="plate-dinner"><img src="plate-dinner.png"></div>
  <div class="draggable" data-item="plate-soup"><img src="plate-soup.png"></div>
  <div class="draggable" data-item="napkin"><img src="napkin.png"></div>

  <div class="draggable" data-item="fork-main"><img src="fork.png"></div>
  <div class="draggable" data-item="fork-second"><img src="fork.png"></div>

  <div class="draggable" data-item="knife"><img src="knife.png"></div>
  <div class="draggable" data-item="spoon"><img src="spoon.png"></div>

  <div class="draggable" data-item="glass-water"><img src="glass-water.png"></div>
  <div class="draggable" data-item="glass-wine"><img src="glass-wine.png"></div>

  <div class="draggable" data-item="spoon-dessert"><img src="spoon-dessert.png"></div>

</div>

<script>
let dragged=null, preview=null;
const table=document.getElementById("table");
let placed=[];
const SNAP_DISTANCE=160;

document.querySelectorAll(".draggable").forEach(el=>{
  el.addEventListener("pointerdown",startDrag);
});

function startDrag(e){
  dragged=e.currentTarget;
  preview=dragged.cloneNode(true);
  preview.classList.add("drag-preview");
  document.body.appendChild(preview);
  move(e);
  document.addEventListener("pointermove",move);
  document.addEventListener("pointerup",drop);
}

function move(e){
  preview.style.left=(e.clientX-32)+"px";
  preview.style.top=(e.clientY-32)+"px";
}

function nearestTarget(x,y){
  let best=null, bestDist=9999;
  document.querySelectorAll(".target").forEach(t=>{
    const r=t.getBoundingClientRect();
    const cx=r.left+r.width/2;
    const cy=r.top+r.height/2;
    const dist=Math.hypot(x-cx,y-cy);
    if(dist<SNAP_DISTANCE && dist<bestDist){
      best=t;
      bestDist=dist;
    }
  });
  return best;
}

function drop(e){
  document.removeEventListener("pointermove",move);
  document.removeEventListener("pointerup",drop);

  const target=nearestTarget(e.clientX,e.clientY);
  preview.remove();
  if(!target) return;

  const item=dragged.dataset.item;

  /* CENTRO LOGICO */
  if(target.id==="t-center"){
    if(item==="plate-dinner" && !placed.includes("plate-dinner")){
      place(item,target,240);
    }
    else if(item==="plate-soup" && placed.includes("plate-dinner")){
      place(item,target,190);
    }
    else if(item==="napkin" && placed.includes("plate-soup")){
      place(item,target,170);
    }
    else return;
  }
  else{
    const id=target.id.replace("t-","");
    if(item!==id) return;
    place(item,target,120);
  }

  dragged.remove();
  placed.push(item);
  checkWin();
}

function place(item,target,size){
  const div=document.createElement("div");
  div.className="on-table";
  div.style.width=size+"px";

  const img=document.createElement("img");
  img.src=(item.includes("fork"))?"fork.png":item+".png";
  div.appendChild(img);

  const r=target.getBoundingClientRect();
  const tr=table.getBoundingClientRect();

  div.style.left=(r.left-tr.left+r.width/2)+"px";
  div.style.top=(r.top-tr.top+r.height/2)+"px";
  div.style.transform="translate(-50%,-50%)";

  table.appendChild(div);
}

function checkWin(){
  if(placed.length===10){
    setTimeout(()=>{window.location.href="stanza9.html";},800);
  }
}
</script>

</body>
</html>
