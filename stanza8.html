<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Stanza 8</title>

<style>
html,body{
  margin:0;
  height:100%;
  font-family:Arial, sans-serif;
  background:#111;
  display:flex;
  flex-direction:column;
  align-items:center;
  color:#fff;
  user-select:none;
}

.header{
  padding:20px 0 10px;
  text-align:center;
}

/* TAVOLO 8x8 */
.table{
  width:min(900px,96vw);
  aspect-ratio:1;
  display:grid;
  grid-template-columns:repeat(8,1fr);
  grid-template-rows:repeat(8,1fr);
  position:relative;
  border-radius:20px;
  overflow:hidden;
  box-shadow:0 25px 60px rgba(0,0,0,.6);

  background:
    repeating-linear-gradient(0deg,#ffffff,#ffffff 40px,#f2f2f2 40px,#f2f2f2 80px),
    repeating-linear-gradient(90deg,#ffffff,#ffffff 40px,#f2f2f2 40px,#f2f2f2 80px);
}

.cell{
  border:1px solid rgba(0,0,0,.05);
  position:relative;
}

/* AREE DI RILASCIO EVIDENZIATE */
.drop-zone{
  position:absolute;
  border:2px dashed rgba(0,0,0,.25);
  border-radius:14px;
  pointer-events:none;
  z-index:2;
}

/* OGGETTI */
.on-table{
  position:absolute;
  pointer-events:none;
  z-index:10;
}

.on-table img{
  width:100%;
  height:auto;
  display:block;
}

/* TOOLBOX */
.toolbox{
  margin-top:25px;
  display:flex;
  flex-wrap:wrap;
  justify-content:center;
  gap:18px;
  width:min(900px,96vw);
}

.draggable{
  width:70px;
  height:70px;
  background:transparent;
  display:flex;
  align-items:center;
  justify-content:center;
  cursor:grab;
}

.draggable img{
  max-width:100%;
  max-height:100%;
  pointer-events:none;
}

.drag-preview{
  position:fixed;
  z-index:9999;
  width:70px;
  height:70px;
  pointer-events:none;
}
.drag-preview img{ width:100%; }
</style>
</head>

<body>

<div class="header">
  <h2>Stanza 8</h2>
  <p>Completa la mise en place corretta</p>
</div>

<div class="table" id="table"></div>

<div class="toolbox">
  <div class="draggable" data-item="plate-dinner"><img src="plate-dinner.png"></div>
  <div class="draggable" data-item="plate-soup"><img src="plate-soup.png"></div>
  <div class="draggable" data-item="napkin"><img src="napkin.png"></div>

  <div class="draggable" data-item="fork-second"><img src="fork.png"></div>
  <div class="draggable" data-item="fork-main"><img src="fork.png"></div>

  <div class="draggable" data-item="knife"><img src="knife.png"></div>
  <div class="draggable" data-item="spoon"><img src="spoon.png"></div>

  <div class="draggable" data-item="glass-water"><img src="glass-water.png"></div>
  <div class="draggable" data-item="glass-wine"><img src="glass-wine.png"></div>

  <div class="draggable" data-item="spoon-dessert"><img src="spoon-dessert.png"></div>
</div>

<script>
const table=document.getElementById("table");
let dragged=null, preview=null;
let placed=[];

/* CREA 8x8 */
for(let r=0;r<8;r++){
  for(let c=0;c<8;c++){
    const cell=document.createElement("div");
    cell.className="cell";
    cell.dataset.r=r;
    cell.dataset.c=c;
    table.appendChild(cell);
  }
}

/* CREA AREE VISIVE */
function addZone(x,y,w,h){
  const z=document.createElement("div");
  z.className="drop-zone";
  z.style.left=x+"%";
  z.style.top=y+"%";
  z.style.width=w+"%";
  z.style.height=h+"%";
  table.appendChild(z);
}

/* Centro */
addZone(37.5,37.5,25,25);

/* Forchette */
addZone(12.5,37.5,12.5,25);
addZone(25,37.5,12.5,25);

/* Destra */
addZone(75,37.5,12.5,25);
addZone(87.5,37.5,12.5,25);

/* Dessert */
addZone(37.5,12.5,25,12.5);

/* Bicchieri */
addZone(62.5,12.5,12.5,12.5);
addZone(75,12.5,12.5,12.5);

const cells=[...document.querySelectorAll(".cell")];

document.querySelectorAll(".draggable").forEach(el=>{
  el.addEventListener("pointerdown",startDrag);
});

function startDrag(e){
  e.preventDefault();
  dragged=e.currentTarget;
  preview=dragged.cloneNode(true);
  preview.classList.add("drag-preview");
  document.body.appendChild(preview);
  move(e);
  document.addEventListener("pointermove",move);
  document.addEventListener("pointerup",drop);
}

function move(e){
  preview.style.left=(e.clientX-35)+"px";
  preview.style.top=(e.clientY-35)+"px";
}

function getCell(x,y){
  return cells.find(cell=>{
    const r=cell.getBoundingClientRect();
    return x>r.left && x<r.right && y>r.top && y<r.bottom;
  });
}

function drop(e){
  document.removeEventListener("pointermove",move);
  document.removeEventListener("pointerup",drop);
  preview.remove();

  const cell=getCell(e.clientX,e.clientY);
  if(!cell) return;

  const r=parseInt(cell.dataset.r);
  const c=parseInt(cell.dataset.c);
  const item=dragged.dataset.item;

  if(r>=3 && r<=5 && c>=3 && c<=5){
    if(item==="plate-dinner" && !placed.includes("plate-dinner"))
      placeCenter(item,360,70);
    else if(item==="plate-soup" && placed.includes("plate-dinner"))
      placeCenter(item,250,70);
    else if(item==="napkin" && placed.includes("plate-soup"))
      placeCenter(item,200,70);
    else return;
  }

  else if(r>=3 && r<=5 && c===1 && item==="fork-second") placeCell(item,cell);
  else if(r>=3 && r<=5 && c===2 && item==="fork-main") placeCell(item,cell);

  else if(r>=3 && r<=5 && c===6 && item==="knife") placeCell(item,cell);
  else if(r>=3 && r<=5 && c===7 && item==="spoon") placeCell(item,cell);

  else if(r===1 && c>=3 && c<=5 && item==="spoon-dessert") placeDessert();

  else if(r===1 && c===5 && item==="glass-water") placeCell(item,cell);
  else if(r===1 && c===6 && item==="glass-wine") placeCell(item,cell);

  else return;

  dragged.remove();
  placed.push(item);
  checkWin();
}

function placeCell(item,cell){
  const div=document.createElement("div");
  div.className="on-table";
  div.style.width="130px";

  const img=document.createElement("img");
  img.src=item.includes("fork")?"fork.png":item+".png";
  div.appendChild(img);

  const r=cell.getBoundingClientRect();
  const t=table.getBoundingClientRect();

  div.style.left=(r.left-t.left+r.width/2)+"px";
  div.style.top=(r.top-t.top+r.height/2)+"px";
  div.style.transform="translate(-50%,-50%)";

  table.appendChild(div);
}

function placeCenter(item,size,down){
  const div=document.createElement("div");
  div.className="on-table";
  div.style.width=size+"px";

  const img=document.createElement("img");
  img.src=item+".png";
  div.appendChild(img);

  div.style.left="50%";
  div.style.top="calc(50% + "+down+"px)";
  div.style.transform="translate(-50%,-50%)";

  table.appendChild(div);
}

function placeDessert(){
  const div=document.createElement("div");
  div.className="on-table";
  div.style.width="200px";

  const img=document.createElement("img");
  img.src="spoon-dessert.png";
  div.appendChild(img);

  div.style.left="50%";
  div.style.top="20%";
  div.style.transform="translate(-50%,-50%) rotate(90deg)";

  table.appendChild(div);
}

function checkWin(){
  if(placed.length===10){
    setTimeout(()=>window.location.href="stanza9.html",800);
  }
}
</script>

</body>
</html>
