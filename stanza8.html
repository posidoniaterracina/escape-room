<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Stanza 8 - Mise en place</title>

<style>
html, body{
  margin:0;
  height:100%;
  font-family:Arial;
  overflow:hidden;
}

body{
  background:linear-gradient(135deg,#121212,#2b1f14);
  color:#fff;
  display:flex;
  flex-direction:column;
  align-items:center;
}

/* Header */
.header{
  width:100%;
  max-width:980px;
  padding:14px 12px 6px 12px;
  box-sizing:border-box;
  text-align:center;
}

.header h1{
  margin:0;
  font-size:22px;
}

.header p{
  margin:6px 0 0 0;
  opacity:.9;
  font-size:13px;
}

/* Layout */
.wrap{
  width:100%;
  max-width:980px;
  display:flex;
  flex-direction:column;
  align-items:center;
  gap:12px;
  padding:6px 10px 14px 10px;
  box-sizing:border-box;
}

/* Tavolo */
.table{
  width:min(820px, 96vw);
  aspect-ratio: 4 / 3;
  position:relative;
  border-radius:22px;
  background:linear-gradient(135deg,#7a4a26,#3b2412);
  box-shadow:0 18px 45px rgba(0,0,0,0.55);
  border:2px solid rgba(255,255,255,0.08);
  overflow:hidden;
}

/* Tovaglia / area posto */
.placemat{
  position:absolute;
  top:50%;
  left:50%;
  transform:translate(-50%,-50%);
  width:76%;
  height:70%;
  border-radius:18px;
  background:rgba(255,255,255,0.08);
  border:2px dashed rgba(255,255,255,0.18);
}

/* Drop targets: invisibili (debug attivabile) */
.target{
  position:absolute;
  width:72px;
  height:72px;
  border-radius:16px;
  /* invisibile */
  outline:0;
  background:transparent;
}

/* Se vuoi debug: aggiungi class="debug" al body */
body.debug .target{
  outline:2px dashed rgba(255,255,255,0.35);
  background:rgba(255,255,255,0.06);
}

/* Feedback */
.target.wrong{
  outline:2px solid rgba(220,53,69,0.9);
  background:rgba(220,53,69,0.15);
}
.target.correct{
  outline:2px solid rgba(40,167,69,0.95);
  background:rgba(40,167,69,0.12);
}

/* Posizioni (mise en place base) */
#t-plate  { top:50%; left:50%; transform:translate(-50%,-50%); width:120px; height:120px; border-radius:999px; }
#t-fork   { top:50%; left:22%; transform:translate(-50%,-50%); }
#t-knife  { top:50%; left:78%; transform:translate(-50%,-50%); }
#t-spoon  { top:50%; left:90%; transform:translate(-50%,-50%); }

/* Bicchieri in alto a destra: acqua (pi√π interno) + vino (pi√π esterno) */
#t-water  { top:24%; left:78%; transform:translate(-50%,-50%); }
#t-wine   { top:22%; left:90%; transform:translate(-50%,-50%); }

/* Tovagliolo: in alto a sinistra (puoi cambiarlo sul piatto se preferisci) */
#t-napkin { top:24%; left:22%; transform:translate(-50%,-50%); }

/* Oggetti ancorati sul tavolo */
.on-table{
  position:absolute;
  display:flex;
  align-items:center;
  justify-content:center;
  user-select:none;
  pointer-events:none; /* una volta piazzati non si spostano */
  font-size:44px;
  filter:drop-shadow(0 8px 12px rgba(0,0,0,0.45));
}

/* ‚ÄúPiatto‚Äù pi√π grande */
.on-table.plate{
  font-size:72px;
}

/* Toolbox */
.toolbox{
  width:min(820px, 96vw);
  background:rgba(0,0,0,0.25);
  border:1px solid rgba(255,255,255,0.14);
  border-radius:18px;
  padding:12px;
  box-sizing:border-box;
  display:flex;
  flex-wrap:wrap;
  justify-content:center;
  gap:12px;
  backdrop-filter:blur(6px);
}

/* Draggable: SOLO OGGETTO */
.draggable{
  width:64px;
  height:64px;
  border-radius:16px;
  display:flex;
  align-items:center;
  justify-content:center;
  font-size:38px;
  cursor:grab;
  user-select:none;
  touch-action:none;
  background:rgba(255,255,255,0.10);
  border:1px solid rgba(255,255,255,0.18);
  box-shadow:0 10px 22px rgba(0,0,0,0.35);
}

.draggable:active{
  transform:scale(1.06);
}

.drag-preview{
  position:fixed;
  z-index:9999;
  pointer-events:none;
  width:64px;
  height:64px;
  border-radius:16px;
  display:flex;
  align-items:center;
  justify-content:center;
  font-size:38px;
  background:rgba(255,255,255,0.14);
  border:1px solid rgba(255,255,255,0.22);
  box-shadow:0 10px 22px rgba(0,0,0,0.35);
  backdrop-filter:blur(6px);
}

/* Mobile: riduci un filo */
@media (max-width:768px){
  html, body{ overflow:hidden; }
  .draggable, .drag-preview{ width:56px; height:56px; font-size:34px; border-radius:14px; }
  .on-table{ font-size:40px; }
  .on-table.plate{ font-size:64px; }

  .target{ width:62px; height:62px; border-radius:14px; }
  #t-plate{ width:110px; height:110px; }
}
</style>
</head>

<body>
  <div class="header">
    <h1>üçΩÔ∏è Stanza 8</h1>
    <p>Completa la mise en place: trascina gli oggetti sul tavolo (vista dall‚Äôalto).</p>
  </div>

  <div class="wrap">

    <div class="table" id="table">
      <div class="placemat"></div>

      <!-- TARGET INVISIBILI -->
      <div class="target" id="t-plate"  data-target="plate"></div>
      <div class="target" id="t-fork"   data-target="fork"></div>
      <div class="target" id="t-knife"  data-target="knife"></div>
      <div class="target" id="t-spoon"  data-target="spoon"></div>
      <div class="target" id="t-water"  data-target="water"></div>
      <div class="target" id="t-wine"   data-target="wine"></div>
      <div class="target" id="t-napkin" data-target="napkin"></div>
    </div>

    <!-- TOOLBOX: SOLO OGGETTI -->
    <div class="toolbox" id="toolbox">
      <!-- ordine non-soluzione -->
      <div class="draggable" data-item="wine"   aria-label="Bicchiere vino">üç∑</div>
      <div class="draggable" data-item="fork"   aria-label="Forchetta">üç¥</div>
      <div class="draggable" data-item="napkin" aria-label="Tovagliolo">üßª</div>
      <div class="draggable" data-item="spoon"  aria-label="Cucchiaio">ü•Ñ</div>
      <div class="draggable" data-item="plate"  aria-label="Piatto">üçΩÔ∏è</div>
      <div class="draggable" data-item="knife"  aria-label="Coltello">üî™</div>
      <div class="draggable" data-item="water"  aria-label="Bicchiere acqua">ü•õ</div>
    </div>

  </div>

<script>
let draggedItem = null;
let preview = null;
let grabOffsetX = 0;
let grabOffsetY = 0;

const table = document.getElementById("table");
const targets = Array.from(document.querySelectorAll(".target"));

document.querySelectorAll(".draggable").forEach(el=>{
  el.addEventListener("pointerdown", startDrag);
});

function startDrag(e){
  e.preventDefault();
  draggedItem = e.currentTarget;

  const rect = draggedItem.getBoundingClientRect();
  grabOffsetX = e.clientX - rect.left;
  grabOffsetY = e.clientY - rect.top;

  preview = draggedItem.cloneNode(true);
  preview.classList.add("drag-preview");
  document.body.appendChild(preview);

  movePreview(e);

  draggedItem.setPointerCapture(e.pointerId);
  document.addEventListener("pointermove", movePreview);
  document.addEventListener("pointerup", endDrag);
}

function movePreview(e){
  if(!preview) return;
  preview.style.left = (e.clientX - grabOffsetX) + "px";
  preview.style.top  = (e.clientY - grabOffsetY) + "px";
}

function endDrag(e){
  if(!preview) return;

  const itemType = draggedItem.dataset.item;
  let hit = null;

  targets.forEach(t=>{
    const r = t.getBoundingClientRect();
    if(e.clientX > r.left && e.clientX < r.right && e.clientY > r.top && e.clientY < r.bottom){
      hit = t;
    }
  });

  preview.remove();
  preview = null;

  document.removeEventListener("pointermove", movePreview);
  document.removeEventListener("pointerup", endDrag);

  if(!hit){
    draggedItem = null;
    return;
  }

  if(hit.classList.contains("correct")){
    // target gi√† occupato
    flashWrong(hit);
    draggedItem = null;
    return;
  }

  if(hit.dataset.target === itemType){
    placeOnTable(itemType, hit);
    draggedItem.remove(); // sparisce dalla toolbox
    hit.classList.add("correct");
    checkWin();
  }else{
    flashWrong(hit);
  }

  draggedItem = null;
}

function flashWrong(target){
  target.classList.add("wrong");
  setTimeout(()=>target.classList.remove("wrong"), 450);
}

function placeOnTable(itemType, target){
  const obj = document.createElement("div");
  obj.className = "on-table " + (itemType === "plate" ? "plate" : "");
  obj.textContent = emojiFor(itemType);

  // posiziona l‚Äôoggetto centrato sul target (dentro la table)
  const tableRect = table.getBoundingClientRect();
  const tRect = target.getBoundingClientRect();

  const centerX = (tRect.left + tRect.right)/2 - tableRect.left;
  const centerY = (tRect.top + tRect.bottom)/2 - tableRect.top;

  obj.style.left = centerX + "px";
  obj.style.top  = centerY + "px";
  obj.style.transform = "translate(-50%, -50%)";

  table.appendChild(obj);
}

function emojiFor(itemType){
  switch(itemType){
    case "plate": return "üçΩÔ∏è";
    case "fork": return "üç¥";
    case "knife": return "üî™";
    case "spoon": return "ü•Ñ";
    case "water": return "ü•õ";
    case "wine": return "üç∑";
    case "napkin": return "üßª";
    default: return "‚ùì";
  }
}

function checkWin(){
  const done = document.querySelectorAll(".target.correct").length;
  if(done === targets.length){
    setTimeout(()=>{ window.location.href = "stanza9.html"; }, 700);
  }
}
</script>

</body>
</html>
